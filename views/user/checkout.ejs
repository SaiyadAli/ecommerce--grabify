<%- include('../partials/grabifyheader.ejs') %>
<div class="container main-container headerOffset">
    <div class="row">
        <div class="breadcrumbDiv col-lg-12">
            <ul class="breadcrumb">
                <li><a href="/user/home">Home</a></li>
                <li><a href="/user/cart">Cart</a></li>
                <li class="active"> Checkout</li>
            </ul>
        </div>
    </div>
    <!--/.row-->

    <div class="row">
        <div class="col-lg-9 col-md-9 col-sm-7">
            <h1 class="section-title-inner"><span><i class="glyphicon glyphicon-shopping-cart"></i>CHECKOUT</span></h1>
        </div>
        <div class="col-lg-3 col-md-3 col-sm-5 rightSidebar">
            <h4 class="caps"><a href="/user/home"><i class="fa fa-chevron-left"></i> Back to shopping </a></h4>
        </div>
    </div>
    <!--/.row-->

    <div class="row">
        <div class="col-lg-9 col-md-9 col-sm-12">
            <div class="row userInfo">
                <div class="col-xs-12 col-sm-12">
                    <div class="w100 clearfix">
                        <div class="row userInfo">
                            <div style="clear: both"></div>
                            <div class="onepage-checkout col-lg-12">
                                <form id="order-form" method="POST">
                                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                                        <div class="panel panel-default">
                                            <div class="panel-heading" role="tab" id="headingOne">
                                                <h4 class="panel-title">
                                                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#BillingInformation"
                                                       aria-expanded="true" aria-controls="BillingInformation">
                                                        Billing and Shipping information
                                                    </a>
                                                </h4>
                                            </div>
                                            <div id="BillingInformation" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="BillingInformation">
                                                <div class="panel-body">
                                                    <div style="clear: both"></div>
                                                    <div id="exisitingAddressBox" class="collapse in">
                                                        <div class="form-group uppercase"><strong>Select address</strong></div>
                                                        <div class="w100 clearfix">
                                                            <% addressData.forEach(address => { %>
                                                            <div class="col-xs-12 col-sm-6 col-md-4">
                                                                <div class="panel panel-default">
                                                                    <div class="panel-heading">
                                                                        <h3 class="panel-title"><strong><%= address.addressAlias %></strong></h3>
                                                                    </div>
                                                                    <div class="panel-body">
                                                                        <ul>
                                                                            <li><span class="address-name"> <strong><%= address.firstName %> <%= address.lastName %></strong></span></li>
                                                                            <li><span class="address-line1"><%= address.street %></span></li>
                                                                            <li><span class="address-line2"><%= address.addressLine2 %></span></li>
                                                                            <li><span> <strong>Mobile</strong> : <%= address.number %></span></li>
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <% }) %>
                                                        </div>
                                                        <!--/.w100-->
                                                        <div class="gap"></div>
                                                        <div class="col-lg-12 clearfix">
                                                            <a class="btn btn-primary" href="/user/addAddress"><i class="fa fa-plus-circle"></i> Add New Address </a>
                                                        </div>
                                                        <div class="gap"></div>
                                                        <div class="form-group required maxwidth300">
                                                            <label for="InputCountry">Select Address <sup>*</sup></label>
                                                            <select class="form-control" required aria-required="true" id="SelectAddress" name="chosenAddress">
                                                                <% addressData.forEach(address => { %>
                                                                <option value="<%= address._id %>"> <%= address.addressAlias %></option>
                                                                <% }) %>
                                                            </select>
                                                            <br>
                                                        </div>
                                                    </div>
                                                    <div class="panel panel-default">
                                                        <div class="panel-heading" role="tab" id="">
                                                            <h4 class="panel-title">
                                                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#Paymentmethod"
                                                                   aria-expanded="false" aria-controls="Paymentmethod">
                                                                    Payment method
                                                                </a>
                                                            </h4>
                                                        </div>
                                                        <div id="Paymentmethod" class="panel-collapse collapse" role="tabpanel">
                                                            <div class="panel-body">
                                                                <div class="onepage-payment">
                                                                    <div style="clear:both;"></div>
                                                                    <div class="card-paynemt-box payment-method">
                                                                        <label class="radio-inline" for="CashOnDelivery" aria-controls="CashOnDeliveryCollapse">
                                                                            <input name="paymentType" id="COD" value="COD" type="radio">Cash On Delivery
                                                                        </label>
                                                                    </div>
                                                                    <div class="card-paynemt-box payment-method">
                                                                        <label class="radio-inline" for="razorpay" aria-controls="CashOnDeliveryCollapse">
                                                                            <input name="paymentType" id="razorpay" value="razorpay" type="radio">Razorpay
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <br>
                                                    <button type="submit" class="pull-left btn btn-primary btn-lg">
                                                        Order &nbsp; <i class="fa fa-arrow-circle-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <!--onepage-checkout-->
                        </div>
                        <!--/row end-->
                    </div>
                </div>
            </div>
            <!--/row end-->
        </div>
        <div class="col-lg-3 col-md-3 col-sm-12 rightSidebar">
            <div class="w100 cartMiniTable">
                <table id="cart-summary" class="std table">
                    <tbody>
                        <tr>
                            <td>Total Price</td>
                            <td class="price" id="totalPrice1">$<%= grandTotal %></td>
                        </tr>
                        <tr style="">
                            <td>Shipping</td>
                            <td class="price">Free shipping!</td>
                        </tr>
                        <!-- <tr>
                            <td>Total Discount</td>
                            <td class="price" id="totalDiscount">â‚¹0</td>
                        </tr> -->
                        <tr>
                            <td>Grand Total</td>
                            <td class="site-color" id="total-price">$<span id="grandTotal"><%= grandTotal %></span></td>
                        </tr>
                        <!-- <tr>
                            <td colspan="2">
                                <div class="input-append couponForm">
                                    <form id="couponApplyForm">
                                        <input class="col-lg-8" name="couponCode" id="appendedInputButton" type="text" placeholder="Enter coupon code">
                                        <button class="col-lg-4 btn btn-success" type="submit">Apply!</button>
                                    </form>
                                </div>
                            </td>
                        </tr> -->
                    </tbody>
                </table>
            </div>
                <div class="cartContent w100">
                    <table class="cartTable table-responsive" style="width:100%">
                        <tbody>
                            <tr class="CartProduct cartTableHeader">
                                <td style="width:25%"> Product</td>
                                <td style="width:60%; text-align: center;">Details</td>
                                <!-- <td style="width:10%">QNT</td>
                                <td style="width:10%">Size</td> -->
                                <td style="width:15%">Total</td>
                            </tr>
                            <% cartItems.forEach(item => { %>
                            <tr class="CartProduct">
                                <td class="CartProductThumb">
                                    <div><a href="<%= item.variantId.images[0] %>"><img src="<%= item.variantId.images[0] %>" alt="img"></a></div>
                                </td>
                                <td>
                                    <div class="CartDescription">
                                        <h4><a href="/product/<%= item.productId._id %>"><%= item.productId.name %>(<%= item.variantId.color %>)</a></h4>
                                        <div class="price"><span>$<%= item.variantId.price %></span></div>
                                    </div>
                                </td>
                                <!-- <td><%= item.quantity %></td>
                                <td><%= item.size %></td> -->
                                <td class="price">$<%= item.variantId.price * item.quantity %></td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            
            <!--  /cartMiniTable-->
        </div>
        <!--/rightSidebar-->
    </div>
    <!--/row-->
    <div style="clear:both"></div>
</div>
<!-- /.main-container-->
<div class="gap"></div>
<%- include('../partials/grabifyfooter.ejs') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.getElementById('order-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = this;

        fetch('/user/create-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chosenAddress: form.chosenAddress.value,
                paymentType: form.paymentType.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Order Created',
                    text: data.message,
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.href = '/user/home';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while creating the order.'
            });
        });
    });
</script>